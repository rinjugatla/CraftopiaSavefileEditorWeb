<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Craftopia OCS savedata edtor</title>

    <style type="text/css">
        #editor {
            position: absolute;
            width: 100%;
            height: 100%;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"
        integrity="sha512-NhSC1YmyruXifcj/KFRWoC561YpHpc5Jtzgvbuzx5VozKpWvQ+4nXhPdFgmx8xqexRcpAglTj9sIBWINXa8x5w=="
        crossorigin="anonymous" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"
        integrity="sha512-EAKzSKex+PXC0U9OG13r1059ysjrjkJEpZoONCnZa0mBROY28iBOOxZSErUVw1LzLr2+U5PhR7zPCPKidUVJqg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="lib/ace/src-min/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="lib/ace/src-min/theme-twilight.js" type="text/javascript" charset="utf-8"></script>
    <script src="lib/ace/src-min/mode-javascript.js" type="text/javascript" charset="utf-8"></script>
    <script src="lib/ace/src-min/mode-json.js" type="text/javascript" charset="utf-8"></script>
    <script>
        window.addEventListener('load', loadedPage);

        function loadedPage() {
            initEditor();

            $(document).on('dragover', '#editor', function (_e) {
                var e = _e;
                if (_e.originalEvent) {
                    e = _e.originalEvent;
                }
                e.stopPropagation();
                e.preventDefault();

                e.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.

            });

            $(document).on('drop', '#editor', function (_e) {
                var e = _e;
                if (_e.originalEvent) {
                    e = _e.originalEvent;
                }
                e.stopPropagation();
                e.preventDefault();

                var files = e.dataTransfer.files; // FileList object.

                for (var i = 0, file; file = files[i]; i++) {

                    // ocsのみ読み込み
                    if (!file.name.endsWith('ocs')) { continue; }
                    var reader = new FileReader();

                    // Closure to capture the file information.
                    reader.onload = (function (loadFile) {
                        return function (e) {
                            var json = pako.ungzip(e.target.result, { to: 'string' });
                            // var formatedJson = json.replace(/\n/g, '<br>');
                            var formatedJson = JSON.stringify(JSON.parse(json), null, 4);
                            editor.setValue(formatedJson);
                            console.log(loadFile.name);
                        };
                    })(file);

                    reader.readAsArrayBuffer(file);
                }
            });
        }

        var editor
        function initEditor() {
            editor = ace.edit("editor");
            editor.setTheme("ace/theme/twilight");
            var jsonMode = ace.require("ace/mode/json").Mode;
            editor.session.setMode(new jsonMode());
        }
    </script>
</head>

<body>
    <div id="editor"></div>
</body>

</html>